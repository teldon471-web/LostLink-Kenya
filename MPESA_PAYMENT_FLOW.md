# M-PESA STK Push Payment Flow - Visual Guide

## Complete Payment Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        COMPLETE PAYMENT FLOW                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: USER INITIATES PAYMENT                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  User browsing blog â†’ Clicks "View Post" (requires payment)                 â”‚
â”‚              â†“                                                              â”‚
â”‚  Redirected to: /post/{id}/pay/                                            â”‚
â”‚              â†“                                                              â”‚
â”‚  POST to pay_post view                                                      â”‚
â”‚              â†“                                                              â”‚
â”‚  âœ… Validate phone number exists in profile                                 â”‚
â”‚  âœ… Trigger stk_push_payment(phone, amount, post_id, user)                  â”‚
â”‚              â†“                                                              â”‚
â”‚  Display: "Waiting for payment..." (waiting.html)                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: GENERATE ACCESS TOKEN (OAuth)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  get_access_token() called                                                  â”‚
â”‚              â†“                                                              â”‚
â”‚  URL: https://sandbox.safaricom.co.ke/oauth/v1/generate                    â”‚
â”‚  Method: GET with HTTPBasicAuth                                             â”‚
â”‚  Auth: MPESA_CONSUMER_KEY + MPESA_CONSUMER_SECRET                           â”‚
â”‚              â†“                                                              â”‚
â”‚  âœ… Parse response.json()["access_token"]                                   â”‚
â”‚  âœ… Validate token exists                                                   â”‚
â”‚  âœ… Log success: "âœ… M-PESA access token generated successfully"            â”‚
â”‚  âœ… Return token for STK Push request                                       â”‚
â”‚              â†“                                                              â”‚
â”‚  Returns: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."                       â”‚
â”‚                                                                              â”‚
â”‚  ERROR HANDLING:                                                             â”‚
â”‚  âŒ Network error â†’ Log & raise Exception                                    â”‚
â”‚  âŒ Invalid JSON â†’ Log & raise Exception                                     â”‚
â”‚  âŒ Missing token â†’ Log & raise ValueError                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: BUILD STK PUSH REQUEST PAYLOAD                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  stk_push_payment() continues...                                            â”‚
â”‚              â†“                                                              â”‚
â”‚  timestamp = datetime.now().strftime("%Y%m%d%H%M%S")                       â”‚
â”‚  Example: "20251206135022"                                                  â”‚
â”‚              â†“                                                              â”‚
â”‚  password = base64.b64encode(SHORTCODE + PASSKEY + timestamp)              â”‚
â”‚  Example: "MTc0Mzc5YmZiMjc5ZjlhYTliZGJjZjE1OGU5N2RkNzFhNDY3YzQyZTBj..."  â”‚
â”‚              â†“                                                              â”‚
â”‚  Build Payload:                                                             â”‚
â”‚  {                                                                          â”‚
â”‚    "BusinessShortCode": "174379",          âœ… From MPESA_SHORTCODE          â”‚
â”‚    "Password": "MTc0Mzc5YmZi...",         âœ… Dynamically generated          â”‚
â”‚    "Timestamp": "20251206135022",          âœ… Current timestamp             â”‚
â”‚    "TransactionType": "CustomerPayBillOnline",  (Fixed)                     â”‚
â”‚    "Amount": 100,                          âœ… From parameter                â”‚
â”‚    "PartyA": 254712345678,                 âœ… Customer phone (cleaned)      â”‚
â”‚    "PartyB": 174379,                       âœ… Business shortcode            â”‚
â”‚    "PhoneNumber": 254712345678,            âœ… For STK display               â”‚
â”‚    "CallBackURL": "https://yourdomain.com/mpesa/callback/",  âœ… Webhook   â”‚
â”‚    "AccountReference": "POST_123_45",      âœ… user_id & post_id            â”‚
â”‚    "TransactionDesc": "Payment for post access"                            â”‚
â”‚  }                                                                          â”‚
â”‚              â†“                                                              â”‚
â”‚  Headers:                                                                   â”‚
â”‚  {                                                                          â”‚
â”‚    "Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",      â”‚
â”‚    "Content-Type": "application/json"                                       â”‚
â”‚  }                                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: SEND STK PUSH REQUEST TO SAFARICOM                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  requests.post(                                                             â”‚
â”‚    "https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest",      â”‚
â”‚    json=payload,                                                            â”‚
â”‚    headers=headers,                                                         â”‚
â”‚    timeout=10                                                               â”‚
â”‚  )                                                                          â”‚
â”‚              â†“                                                              â”‚
â”‚  SAFARICOM RESPONSE:                                                        â”‚
â”‚  {                                                                          â”‚
â”‚    "MerchantRequestID": "12345-67890",                                      â”‚
â”‚    "CheckoutRequestID": "ws_CO_DMZ_abc123...",                             â”‚
â”‚    "ResponseCode": "0",          âœ… Success (other codes = error)           â”‚
â”‚    "ResponseDescription": "Success. Request accepted for processing"        â”‚
â”‚    "CustomerMessage": "Success. Request accepted for processing"            â”‚
â”‚  }                                                                          â”‚
â”‚              â†“                                                              â”‚
â”‚  âœ… Check ResponseCode == "0"                                               â”‚
â”‚  âœ… Log: "âœ… STK Push sent successfully. CheckoutRequestID: ws_CO_..."      â”‚
â”‚  âœ… Return response to pay_post view                                        â”‚
â”‚                                                                              â”‚
â”‚  ERROR HANDLING:                                                             â”‚
â”‚  âŒ Network timeout â†’ Log & raise Exception                                  â”‚
â”‚  âŒ HTTP error â†’ raise_for_status() raises exception                        â”‚
â”‚  âŒ Non-zero ResponseCode â†’ Log warning, return response anyway             â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: USER SEES PAYMENT PROMPT ON PHONE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ğŸ“± M-PESA STK Push Prompt on User's Phone:                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚  M-PESA STK Push                        â”‚                               â”‚
â”‚  â”‚                                         â”‚                               â”‚
â”‚  â”‚  Business: LostLink Kenya                â”‚                               â”‚
â”‚  â”‚  Amount: KES 100.00                     â”‚                               â”‚
â”‚  â”‚                                         â”‚                               â”‚
â”‚  â”‚  [Enter M-PESA PIN]                     â”‚                               â”‚
â”‚  â”‚  [               ]                      â”‚                               â”‚
â”‚  â”‚                                         â”‚                               â”‚
â”‚  â”‚  [Send]      [Cancel]                   â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚              â†“                                                              â”‚
â”‚  User enters PIN and taps [Send]                                           â”‚
â”‚  Transaction processed by Safaricom                                        â”‚
â”‚              â†“                                                              â”‚
â”‚  Payment succeeds OR fails                                                 â”‚
â”‚  Safaricom triggers CALLBACK                                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: SAFARICOM SENDS CALLBACK TO WEBHOOK                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Safaricom POSTs to: {MPESA_CALLBACK}/mpesa/callback/                      â”‚
â”‚              â†“                                                              â”‚
â”‚  URL: /mpesa/callback/ â†’ mpesa_callback(request) view                      â”‚
â”‚  Method: POST                                                               â”‚
â”‚  @csrf_exempt: Yes (required - Safaricom doesn't know CSRF token)           â”‚
â”‚              â†“                                                              â”‚
â”‚  CALLBACK PAYLOAD (JSON):                                                   â”‚
â”‚  {                                                                          â”‚
â”‚    "Body": {                                                                â”‚
â”‚      "stkCallback": {                                                       â”‚
â”‚        "MerchantRequestID": "12345-67890",                                  â”‚
â”‚        "CheckoutRequestID": "ws_CO_DMZ_abc123...",                         â”‚
â”‚        "ResultCode": 0,          âœ… 0 = Success, other = failure            â”‚
â”‚        "ResultDesc": "The service request...",                              â”‚
â”‚        "CallbackMetadata": {                                                â”‚
â”‚          "Item": [                                                          â”‚
â”‚            {"Name": "Amount", "Value": 100},                               â”‚
â”‚            {"Name": "MpesaReceiptNumber", "Value": "ABC123XYZ"},           â”‚
â”‚            {"Name": "TransactionDate", "Value": 20251206135022},           â”‚
â”‚            {"Name": "PhoneNumber", "Value": 254712345678},                 â”‚
â”‚            {"Name": "AccountReference", "Value": "POST_123_45"}            â”‚
â”‚          ]                                                                  â”‚
â”‚        }                                                                    â”‚
â”‚      }                                                                      â”‚
â”‚    }                                                                        â”‚
â”‚  }                                                                          â”‚
â”‚              â†“                                                              â”‚
â”‚  âœ… Parse JSON                                                              â”‚
â”‚  âœ… Log: "ğŸ“¨ M-PESA Callback received..."                                   â”‚
â”‚  âœ… Extract ResultCode                                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: PROCESS CALLBACK & RECORD PAYMENT                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  if ResultCode == 0:  âœ… Payment successful                                 â”‚
â”‚      â†“                                                                      â”‚
â”‚      Extract Metadata:                                                      â”‚
â”‚      â€¢ amount = 100                                                         â”‚
â”‚      â€¢ mpesa_receipt = "ABC123XYZ"                                          â”‚
â”‚      â€¢ transaction_date = 20251206135022                                    â”‚
â”‚      â€¢ phone = 254712345678                                                 â”‚
â”‚      â€¢ account_reference = "POST_123_45"                                    â”‚
â”‚              â†“                                                              â”‚
â”‚      Parse AccountReference "POST_123_45":                                  â”‚
â”‚      â€¢ post_id = 123                                                        â”‚
â”‚      â€¢ user_id = 45                                                         â”‚
â”‚              â†“                                                              â”‚
â”‚      Query Database:                                                        â”‚
â”‚      â€¢ user = User.objects.get(pk=45)  âœ… From user_id                      â”‚
â”‚      â€¢ post = Post.objects.get(pk=123) âœ… From post_id                      â”‚
â”‚              â†“                                                              â”‚
â”‚      Update Payment Access:                                                 â”‚
â”‚      PaymentAccess.objects.update_or_create(                                â”‚
â”‚        user=user,                                                           â”‚
â”‚        post=post,                                                           â”‚
â”‚        defaults={"paid": True}                                              â”‚
â”‚      )                                                                      â”‚
â”‚              â†“                                                              â”‚
â”‚      âœ… Log: "âœ… Payment recorded - Created PaymentAccess for user 45"      â”‚
â”‚                                                                              â”‚
â”‚  else: âŒ Payment failed (ResultCode != 0)                                  â”‚
â”‚      â†“                                                                      â”‚
â”‚      âœ… Log warning with error details                                      â”‚
â”‚      No PaymentAccess created                                               â”‚
â”‚      User cannot view post content                                          â”‚
â”‚                                                                              â”‚
â”‚  ERROR HANDLING:                                                             â”‚
â”‚  âŒ Invalid JSON â†’ Log error                                                â”‚
â”‚  âŒ Missing fields â†’ Log error                                              â”‚
â”‚  âŒ Invalid AccountReference â†’ Log error                                    â”‚
â”‚  âŒ User/Post not found â†’ Log warning                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: RETURN ACK TO SAFARICOM & USER SEES RESULT                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Return to Safaricom:                                                       â”‚
â”‚  JsonResponse({                                                             â”‚
â”‚    "ResultCode": 0,                                                         â”‚
â”‚    "ResultDesc": "Callback received and processed"                          â”‚
â”‚  })                                                                         â”‚
â”‚              â†“                                                              â”‚
â”‚  Safaricom receives acknowledgment (stops retrying)                        â”‚
â”‚              â†“                                                              â”‚
â”‚  User's Browser (polling waiting.html):                                    â”‚
â”‚  â€¢ JavaScript checks payment status every 3 seconds                         â”‚
â”‚  â€¢ Once PaymentAccess.paid = True is detected                               â”‚
â”‚  â€¢ Redirect to: /post/{id}/  (can now view full post)                       â”‚
â”‚                                                                              â”‚
â”‚  SUCCESS PAGE:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ âœ… Payment Successful                â”‚                                   â”‚
â”‚  â”‚                                     â”‚                                   â”‚
â”‚  â”‚ Receipt: ABC123XYZ                  â”‚                                   â”‚
â”‚  â”‚ Amount: KES 100                     â”‚                                   â”‚
â”‚  â”‚ Date: 2025-12-06                    â”‚                                   â”‚
â”‚  â”‚                                     â”‚                                   â”‚
â”‚  â”‚ [View Post]                         â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SECURITY & VALIDATION CHECKPOINTS                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  âœ… STEP 1-2: User authentication (login_required)                          â”‚
â”‚  âœ… STEP 2-3: Phone number validation (profile check)                       â”‚
â”‚  âœ… STEP 3: Password generation with timestamp (prevents replay)           â”‚
â”‚  âœ… STEP 4: Bearer token in headers (OAuth authentication)                  â”‚
â”‚  âœ… STEP 6: @csrf_exempt on callback (Safaricom webhook)                    â”‚
â”‚  âœ… STEP 7: ResultCode validation (only accept 0)                           â”‚
â”‚  âœ… STEP 7: Dual lookup (user_id & post_id from reference)                  â”‚
â”‚  âœ… STEP 8: Always return success to Safaricom (prevent retries)            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Transaction Record

```
After successful payment, PaymentAccess table is updated:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ users_paymentaccess                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id  â”‚ user_id â”‚ post_id â”‚ paid  â”‚ created_at           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ 45      â”‚ 123     â”‚ True  â”‚ 2025-12-06 13:50:22  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

When user visits /post/123/:
  post_detail() view checks:
    PaymentAccess.objects.filter(
      user=user,
      post=post,
      paid=True
    ).exists()
    
  âœ… Returns True â†’ Full post content displayed
  âŒ Returns False â†’ Show payment form
```

---

## Error Scenarios & Recovery

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 1: Network Error During OAuth                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Exception: requests.exceptions.ConnectionError                      â”‚
â”‚ Handler: Caught, logged, re-raised as Exception                     â”‚
â”‚ User sees: "An error occurred: Failed to get access token"          â”‚
â”‚ Recovery: User clicks "Pay Again" to retry                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 2: STK Push Returns Error Code                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Response: {"ResponseCode": "1", "ResponseDescription": "..."}       â”‚
â”‚ Handler: Logged as warning, displayed to user                       â”‚
â”‚ User sees: "Payment request failed: <error message>"                â”‚
â”‚ Recovery: User corrects issue (e.g., phone number) and retries      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 3: Missing Phone Number                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Check: if not request.user.profile.phone_number:                    â”‚
â”‚ Handler: Redirect to profile update page                            â”‚
â”‚ User sees: "Please add your phone number in your profile"           â”‚
â”‚ Recovery: User adds phone number, returns to payment                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 4: User Not Found in Callback                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Check: Profile.objects.get(user__pk=user_id)                        â”‚
â”‚ Handler: Log warning, skip payment recording                        â”‚
â”‚ Log: "âš ï¸ User with ID 45 not found"                                 â”‚
â”‚ Status: Payment received by Safaricom but not recorded              â”‚
â”‚ Recovery: Manual intervention needed (replay callback)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 5: Callback Timeout (Safaricom Retries)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Behavior: Always return ResultCode 0 to Safaricom                   â”‚
â”‚ Effect: Prevents Safaricom from retrying multiple times             â”‚
â”‚ Database: update_or_create handles duplicate callbacks gracefully   â”‚
â”‚ Result: Payment recorded exactly once (idempotent)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Improvements Summary

| Component | Improvement |
|-----------|-------------|
| **OAuth** | Error handling, timeout, validation |
| **STK Push** | Dynamic password, dynamic values, timeouts |
| **Callback** | Robust parsing, named metadata extraction, validation |
| **Payment Recording** | User lookup by ID, idempotent update_or_create |
| **Logging** | All operations logged with emoji indicators |
| **Error Handling** | Try/except blocks, user-friendly messages |
| **Security** | CSRF exemption for webhook, timestamp-based passwords |
| **Debugging** | Detailed logs for troubleshooting failures |

---

*Updated: December 6, 2025*
